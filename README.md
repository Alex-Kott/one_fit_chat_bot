# Prerequisites

Бот работает на Python 3.6. Работал и тестировался только на Ubuntu 16.04 с использованием virtualenv. Пакеты для virtualenv находятся в requirements.txt. В качестве СУБД используется sqlite, операции с БД выполняются с помощью ORM peewee.

Приложение состоит из двух компонентов, работающих независимо: непосредственно бот и интерфейс для администратора/тренеров. Бот опирается на библиотеку pyTelegramBotAPI, файлы бота находятся в папке bot. Основные файлы бота:
- bot.py (непосредственно бот)
- bot_models.py (модели, используемые для работы бота)
- check.py (здесь описаны некоторые валидирующие функции -- проверка введённого роста, веса, etc)
- functions.py (здесь описаны некоторые служебные функции -- отправка почты, инициализация роутинга)
- strings.py (строковые ресурсы: состояния, сообщения, кнопки, etc)
- config.py (нет в репозитории, должен находиться в папке с ботом, описывает сервисные переменные, такие как API_TOKEN, переменные для установки вебхуков и т.д. Подробнее смотри соответствующую секцию)

Админка представляет из себя обычное Django-приложение.

# Deploy

Компоненты (админка и бот) запускаются отдельно, но используют одно и то же виртуальное окружение и БД. Для начала нужно установить пакеты из requirements.txt и активировать виртуальное окружение. Админку можно запустить из отдельного окна screen (на проде она так и запущена) так же как и любое django-приложение: *python manage.py runserver 0.0.0.0:80*

Для запуска бота нужно настроить конфиг-файл (определить следующие переменные):
- LAUNCH_MODE -- может принимать значения DEV и PROD. Разница в том, что если бот запущен в DEV-режиме, то для работы бота используется long_polling (т.е. можно запускать бота с локальной машины). PROD-режим использует для подключения вебхуки (т.е. нужен белый IP)
- API_TOKEN -- здесь и далее должно быть всё понятно, если что -- смотри документацию к BotAPI.
- WEBHOOK_HOST = '127.0.0.1'
- WEBHOOK_PORT = 443  # 443, 80, 88 or 8443 (port need to be 'open')
- WEBHOOK_LISTEN = '0.0.0.0'  # In some VPS you may need to put here the IP addr

- WEBHOOK_SSL_CERT = '/home/user/certs/webhook_cert.pem'  # Path to the ssl certificate
- WEBHOOK_SSL_PRIV = '/home/user/certs/webhook_pkey.pem'  # Path to the ssl private key

- WEBHOOK_URL_BASE = "https://{}:{}".format(WEBHOOK_HOST, WEBHOOK_PORT)
- WEBHOOK_URL_PATH = "/{}/".format(API_TOKEN)

На время разработки бота можно запускать просто с помощью *python bot.py* из папки ./bot/, однако на проде бот запускается с помощью service-файла по адресу /etc/systemd/system/fitchat_bot.service 

# Немного о механике работы бота

Бот поддерживает команду /init (нужно раскомментить соответствующие строки) для создания таблиц БД если БД создаётся с нуля. В репозитории уже есть рабочая версия, так что это не должно понадобиться. 

Как осуществляется следование сценарию?
У каждого юзера есть поле state, которое соответствует тому на каком этапе сейчас находится пользователь. Есть несколько служебных состояний (pause, stop, canceled) и остальные состояния, которые соответствуют определённому этапу. Все состояния описаны в string.py в соответствующей секции. Также сущестует так называемая таблица роутинга (routing.sql), которая описает какая функция должна выполниться на определённом этапе. Это определяется двумя вещами: непосредственно state'ом пользователя и то, какой вид сообщения от него пришёл (text, photo, callback_data)

Также в отдельном процессе запущен watcher, который отслеживает не пришло ли время начать новый день или напомнить пользователю о том, что от него ожидается ответ.

Если появятся дополнительные вопросы со мной можно связаться по почте alexey.kott@gmail.com
